---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Login">
<div class="min-h-screen flex">
  <!-- Panel izquierdo decorativo -->
  <div class="hidden lg:flex lg:w-1/2 relative overflow-hidden" style="background:linear-gradient(135deg,#0D0D18,#12121F)">
    <div class="absolute inset-0">
      <div class="absolute top-20 left-20 w-72 h-72 rounded-full opacity-30 animate-float"
        style="background:radial-gradient(circle,#00D4FF,transparent 70%)"></div>
      <div class="absolute bottom-20 right-20 w-56 h-56 rounded-full opacity-20 animate-float"
        style="background:radial-gradient(circle,#9B5CFF,transparent 70%);animation-delay:3s"></div>
    </div>
    <div class="relative z-10 flex flex-col justify-center px-16 w-full">
      <a href="/" class="flex items-center gap-3 mb-16">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold text-xl"
          style="background:linear-gradient(135deg,#00D4FF,#9B5CFF)"></div>
        <span class="font-display font-bold text-2xl">API</span>
      </a>
      <h2 class="font-display font-black text-5xl leading-tight mb-6" style="letter-spacing:-0.03em">
        Bienvenido<br>de vuelta
      </h2>
      <p class="text-lg" style="color:rgba(240,240,255,0.5)">Ingresa a tu cuenta para acceder al dashboard completo.</p>
      
      <!-- Credenciales demo -->
      <div class="mt-12 p-5 rounded-2xl" style="background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.15)">
        <p class="text-xs font-semibold mb-3" style="color:#00D4FF;letter-spacing:0.1em;text-transform:uppercase">Demo credentials</p>
        <div class="space-y-2 font-mono text-sm">
          <div class="flex gap-3">
            <span style="color:rgba(240,240,255,0.4)">user</span>
            <span class="font-semibold">admin</span>
          </div>
          <div class="flex gap-3">
            <span style="color:rgba(240,240,255,0.4)">pass</span>
            <span class="font-semibold">admin123</span>
          </div>
        </div>
        <button id="fillDemo"
          class="mt-3 text-xs px-3 py-1 rounded-lg transition-all hover:opacity-80"
          style="background:rgba(0,212,255,0.15);color:#00D4FF;border:1px solid rgba(0,212,255,0.2)">
          Rellenar automáticamente →
        </button>
      </div>
    </div>
  </div>

  <!-- Panel derecho - formulario -->
  <div class="w-full lg:w-1/2 flex items-center justify-center px-6 py-12">
    <div class="w-full max-w-md">
      <!-- Logo mobile -->
      <div class="lg:hidden flex items-center gap-3 mb-10">
        <div class="w-9 h-9 rounded-xl flex items-center justify-center font-bold"
          style="background:linear-gradient(135deg,#00D4FF,#9B5CFF)">N</div>
        <span class="font-display font-bold text-xl">API</span>
      </div>

      <div class="mb-8 page-enter">
        <h1 class="font-display font-black text-3xl mb-2" style="letter-spacing:-0.03em">Iniciar Sesión</h1>
        <p style="color:rgba(240,240,255,0.45);font-size:0.9rem">¿No tienes cuenta? 
          <a href="/register" style="color:#00D4FF" class="hover:underline">Regístrate aquí</a>
        </p>
      </div>

      <form id="loginForm" class="space-y-5 page-enter" style="animation-delay:0.1s">
        <div>
          <label class="block text-sm font-semibold mb-2" style="color:rgba(240,240,255,0.7);font-family:'Outfit',sans-serif">
            Usuario o Email
          </label>
          <input id="username" name="username" type="text" required
            class="input-dark" placeholder="usuario o email" autocomplete="username" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2" style="color:rgba(240,240,255,0.7);font-family:'Outfit',sans-serif">
            Contraseña
          </label>
          <div class="relative">
            <input id="password" name="password" type="password" required
              class="input-dark pr-12" placeholder="••••••••" autocomplete="current-password" />
            <button type="button" id="togglePass"
              class="absolute right-4 top-1/2 -translate-y-1/2 transition-opacity hover:opacity-100"
              style="color:rgba(240,240,255,0.35)">
              <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
        </div>

        <div id="errorAlert" class="alert-error rounded-xl text-sm">
          <span id="errorText"></span>
        </div>

        <button type="submit" id="submitBtn" class="btn-primary w-full py-4 text-base mt-2">
          <span id="btnText">Iniciar Sesión</span>
        </button>
      </form>
    </div>
  </div>
</div>
</Layout>

<script>
  import api from '../lib/api.js';
  import { saveUser } from '../lib/auth.js';

  const form = document.getElementById('loginForm');
  const errorAlert = document.getElementById('errorAlert');
  const errorText = document.getElementById('errorText');
  const submitBtn = document.getElementById('submitBtn');
  const btnText = document.getElementById('btnText');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');

  // Toggle password visibility
  document.getElementById('togglePass')?.addEventListener('click', () => {
    const isPass = passwordInput.type === 'password';
    passwordInput.type = isPass ? 'text' : 'password';
  });

  // Rellenar credenciales demo
  document.getElementById('fillDemo')?.addEventListener('click', () => {
    usernameInput.value = 'admin';
    passwordInput.value = 'admin123';
    usernameInput.focus();
    showToast('Credenciales demo listas ✓', 'info');
  });

  function setLoading(loading) {
    submitBtn.disabled = loading;
    btnText.textContent = loading ? 'Verificando...' : 'Iniciar Sesión';
  }

  function showError(msg) {
    errorText.textContent = msg;
    errorAlert.classList.add('alert-visible');
    submitBtn.style.animation = 'shake 0.4s ease';
    setTimeout(() => submitBtn.style.animation = '', 400);
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorAlert.classList.remove('alert-visible');
    setLoading(true);

    try {
      await api.login(usernameInput.value.trim(), passwordInput.value);
      const user = await api.getCurrentUser();
      saveUser(user);
      showToast(`¡Bienvenido, ${user.full_name}!`, 'success');
      setTimeout(() => window.location.href = '/dashboard', 800);
    } catch (err) {
      showError(err.message || 'Credenciales incorrectas');
      setLoading(false);
    }
  });
</script>

<style>
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }
</style>
